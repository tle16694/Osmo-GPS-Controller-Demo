# 常见问题与解答

本文档旨在解答开发过程中可能遇到的一些常见问题。

提示：本 Demo 代码仅供参考。如遇到 BUG，建议将复现过程的视频或照片、输出日志及复现方法一并提交至 issue，我们将尽快处理。同时也欢迎您提交 PR，参与修复与优化。

## 1. 遥控器与相机通信时的特性值

| **特性** | **说明**                           |
| -------- | ---------------------------------- |
| 0xFFF4   | 相机发送，遥控器接收，需要使能通知 |
| 0xFFF5   | 相机接收，遥控器发送               |

参考代码：

```c
/* 这里定义想要过滤的 Service/Characteristic UUID，供搜索使用 */
#define REMOTE_TARGET_SERVICE_UUID   0xFFF0
#define REMOTE_NOTIFY_CHAR_UUID      0xFFF4
#define REMOTE_WRITE_CHAR_UUID       0xFFF5
```

连接建立后，仅需处理以 `0xAA` 开头的帧（DJI R SDK Protocol），其他广播数据可直接忽略。

## 2. 如何休眠与唤醒相机？

相机既可以通过长按电源按键进入休眠状态，也可以通过遥控器操作实现休眠。长按遥控器上的拍录键，相机会进入休眠模式。休眠状态下，单击任意按键可唤醒相机；如果单击的是拍录键，相机将被唤醒并立即开始拍摄，拍摄结束后自动重新进入休眠状态。

请注意以下几点：

- 相机进入休眠后，请停止向相机发送任何数据。
- 收到相机的休眠应答后，即可视为相机已成功休眠，此时蓝牙连接仍会保持。
- 在相机休眠过程中，可能仍会推送几帧状态数据，可安全忽略。
- 当相机被唤醒时，其蓝牙连接会短暂断开，遥控器需自动完成重连。
- 想要广播唤醒目标相机，前提是最近一段时间先使用遥控器成功连接该相机。

详细实现参考：[DATA 数据段详细文档](protocol_data_segment_CN.md) 中的 **相机电源模式设置（001A）** 功能。

## 3. 如何屏蔽升级？

在连接请求协议中的 `fw_version` 字节位置填入 0，该操作需相机已更新至最新固件版本方可支持。

详细实现参考：[DATA 数据段详细文档](protocol_data_segment_CN.md) 中的 **连接请求（0019）** 功能。

## 4. 如何识别相机广播？

可通过判断厂商字段的特定字节来识别是否为支持的相机，判断逻辑如下：当厂商字段的第 0、1 和 4 字节分别为 0xAA、0x08 和 0xFA 时，表示该相机为支持设备。

详细实现参考 `ble.c` 文件中的 `bsp_link_is_dji_camera_adv` 函数。

## 5. 模拟 GPS 命令帧推送但是仪表盘数据异常？

不建议使用模拟数据方式构造 [DATA 数据段详细文档](protocol_data_segment_CN.md) 中的 **GPS 数据推送（0017）** 命令帧。因为仪表盘功能依赖这些数据，使用非真实数据可能导致 APP 中仪表盘显示异常。

真实构造的 GPS 命令帧可参考 `test_gps.c` 文件。在 `app_main.c` 中调用 `start_ble_packet_test(1)` 可实现以 1Hz 频率循环推送，供测试使用。后续我们将持续完善这些测试数据，也欢迎大家提交更多真实有效的测试样本。

## 6. 唤醒后 snapshot 功能实现

先通过广播唤醒数据以唤醒相机。

相机唤醒后，仅需上报快门键的单击事件。

相机拍摄 / 录制完成后将自动进入休眠状态。

详细实现参考：[DATA 数据段详细文档](protocol_data_segment_CN.md) 中的 **按键上报（0011）** 功能。

## 7. **倍率的计算**

慢动作下，倍率等于帧率 / 30。

运动延时下，倍率等于延时间隔。

静止延时下，没有倍率显示，只有间隔时间。

## 8. 相机模式对应 UI 设计

参考：[DATA 数据段详细文档](protocol_data_segment_CN.md) 中的 **相机状态推送（1D02）** 和 **新相机状态推送（1D06）** 命令集，后面有详细给出不同相机模式下，参数如何显示，如何与帧字段对应。

也可参考 DJI Osmo Action 蓝牙遥控器的界面设计。

## 9. 在什么时候进行 GPS 数据推送？

遥控器在成功连接至相机后，应立即以 10Hz 的频率开始推送 GPS 信息，而不是等到视频开始录制时再推送。同时，建议增加指示灯，用于显示当前是否已获取到 GPS 信号。

## 10. 按键上报 QS 键和统一模式切换命令的区别？

**按键上报 QS 键** 相当于短按相机上的 QS 键（通常是电源键），切换到的具体模式由相机内部设置决定，遥控器无需指定目标模式，仅需发送按键上报命令。按下一次将进入快速切换列表中的第一个模式，继续短按可依次切换后续模式。

**统一模式切换** 则支持直接切换到指定的拍摄模式，适用于“一键进入 XX 模式”的场景，更加明确和快捷。

## 11. 如何实现拍录控制？

实现该功能有两种方案：

一种是通过 **拍录控制命令（1D03）** 来控制；但我们更推荐使用 **按键上报命令（0011）** 中的拍录键方式实现，该方式等效于短按相机的拍摄按钮，无需判断当前是否处于录制状态，逻辑更为简单可靠。

## 12. 无法连接相机？

在相机中下拉菜单，点击设置，进入无线连接，确保无线连接已开启，并重置连接。

## 13. Osmo Action 4 的 FFF4 NOTIFY 接收不到消息？

在 FFF4 NOTIFY 下，Osmo Action 4 与 Osmo Action 5 Pro 的表现略有差异：Osmo Action 5 Pro 会推送一些以 `0x55` 开头的帧（可忽略），而 Osmo Action 4 不会。

建议使用蓝牙调试工具实时监听 Osmo Action 4 的 FFF4 NOTIFY，并向 FFF5 发送命令进行测试。测试所用的命令帧可参考 `connect_cmd_frame.txt` 文件中的连接请求帧，也可通过 `connect_cmd_frame_builder.c` 构造并进行验证。
